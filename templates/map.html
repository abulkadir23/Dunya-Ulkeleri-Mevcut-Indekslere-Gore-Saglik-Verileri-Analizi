{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dünya Haritası</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Bootstrap CSS ve JS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Charts için -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .navbar {
            margin-bottom: 20px;
            background-color: #e3f2fd;
        }
        .navbar-brand {
            color: #2196f3 !important;
            font-weight: bold;
        }
        .nav-link {
            color: #64b5f6 !important;
        }
        .nav-link:hover {
            color: #1976d2 !important;
        }
        .btn-outline-primary {
            color: #2196f3;
            border-color: #2196f3;
        }
        .btn-outline-primary:hover {
            background-color: #2196f3;
            color: white;
        }
        .map-container {
            max-width: 1600px;
            margin: 0 60px 20px 60px;
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        #map {
            width: 100%;
            height: 600px;
            border-radius: 5px;
        }
        .info {
            padding: 10px 15px;
            font: 15px/18px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            position: absolute !important;
            top: 30px;
            left: 30px;
            margin: 0 !important;
            z-index: 1000;
            min-width: 250px;
        }
        .info h4 {
            margin: 0 0 8px;
            color: #1976d2;
            font-size: 16px;
            font-weight: bold;
        }
        .search-container {
            position: fixed;
            top: 80px;
            right: 80px;
            width: 250px;
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            justify-content: flex-end;
        }
        .search-wrapper {
            background-color: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            width: 100%;
        }
        .search-container .input-group {
            width: 100%;
            position: relative;
            display: flex;
            align-items: center;
        }
        .search-container input {
            height: 34px;
            border: 1px solid #e3f2fd;
            border-radius: 8px 0 0 8px;
            font-size: 14px;
            padding-left: 15px;
            width: calc(100% - 40px);
            flex: 1;
        }
        .search-container .btn {
            height: 34px;
            width: 40px;
            padding: 0;
            font-size: 14px;
            background-color: #2196f3;
            border: none;
            border-radius: 0 8px 8px 0;
            position: absolute;
            right: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .search-container .btn:hover {
            background-color: #1976d2;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1001;
            max-height: 300px;
            overflow-y: auto;
        }
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        /* Mobil uyumluluk için medya sorgusu */
        @media (max-width: 768px) {
            .search-container {
                top: 100px;
                right: 20px;
                width: 220px;
                max-width: 300px;
            }
        }
        /* Scrollbar tasarımı */
        .search-results::-webkit-scrollbar {
            width: 8px;
        }
        .search-results::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 8px;
        }
        .search-results::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 8px;
        }
        .search-results::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .info-grid-container {
            width: 800px;
            margin: 0;
            margin-left: 60px;
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .row {
            margin: 0;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .col-md-3 {
            width: 25%;
            padding-right: 6px;
            padding-left: 6px;
            margin: 0;
        }
        .info-box {
            background-color: #fff;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
            border: 1px solid #e3f2fd;
            transition: all 0.3s ease;
            position: relative;
            min-height: 65px;
            overflow: visible;
        }
        .info-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
        }
        .info-title {
            font-weight: 600;
            color: #1976d2;
            font-size: 0.8rem;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-right: 50px;
        }
        .info-content {
            color: #546e7a;
            font-size: 0.9rem;
            font-weight: 500;
            padding-right: 50px;
        }
        .card {
            background: transparent;
            border: none;
            box-shadow: none;
        }
        .card-header {
            background-color: transparent;
            border: none;
            padding: 20px 0;
        }
        .card-title {
            color: #1976d2;
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
        }
        .card-body {
            padding: 0;
        }
        .btn-auth {
            color: #fff;
            background-color: #1976d2;
            border: none;
            padding: 8px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-auth:hover {
            background-color: #1565c0;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(25, 118, 210, 0.2);
        }
        .btn-auth.register {
            background-color: #2196f3;
        }
        .btn-auth.register:hover {
            background-color: #1976d2;
        }
        /* Harita kontrolleri için stil */
        .leaflet-control-zoom {
            position: absolute !important;
            bottom: 40px;
            left: 30px;
            margin: 0 !important;
            z-index: 1000;
        }
        .leaflet-bar {
            border: none !important;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;
        }
        .leaflet-bar a {
            width: 40px !important;
            height: 40px !important;
            line-height: 40px !important;
            font-size: 20px !important;
            color: #1976d2 !important;
            background-color: white !important;
            border: none !important;
            display: block !important;
        }
        .leaflet-bar a:first-child {
            border-radius: 4px 4px 0 0 !important;
        }
        .leaflet-bar a:last-child {
            border-radius: 0 0 4px 4px !important;
        }
        .leaflet-bar a:hover {
            background-color: #f8f9fa !important;
            color: #1565c0 !important;
        }
        .leaflet-touch .leaflet-bar a {
            width: 40px !important;
            height: 40px !important;
            line-height: 40px !important;
        }
        /* Harita attribution'ı için stil */
        .leaflet-control-attribution {
            position: absolute;
            bottom: 0;
            right: 0;
            padding: 5px 8px !important;
            background-color: rgba(255,255,255,0.8) !important;
        }
        .gauge-container {
            position: absolute;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            overflow: visible;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }
        .google-visualization-gauge > svg {
            display: block;
            margin: 0;
            width: 100% !important;
            height: 100% !important;
        }
        .google-visualization-gauge {
            width: 40px !important;
            height: 40px !important;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        /* SVG elementlerinin tam görünmesini sağla */
        .google-visualization-gauge svg > g {
            transform: translate(20px, 20px) !important;
        }
        /* Sütun genişliklerini ayarla */
        .col-md-4 {
            padding-right: 6px;
            padding-left: 6px;
        }
        .bottom-content {
            max-width: 1600px;
            margin-left: 20px;
            padding: 0;
        }
        /* Bootstrap margin ve padding sıfırlama */
        .container {
            margin: 0;
            padding: 0;
            max-width: none;
        }
        .country-name-container {
            background-color: white;
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            width: 800px;
            margin-left: 60px;
            margin-bottom: 20px;
        }
        .country-name {
            margin: 0;
            color: #1976d2;
            font-size: 24px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #eee;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-item:hover {
            background-color: #f8f9fa;
        }
        .input-group .form-control {
            border-radius: 8px 0 0 8px;
            border: 2px solid #dee2e6;
        }
        .input-group .btn {
            border-radius: 0 8px 8px 0;
            padding: 0.5rem 1.5rem;
        }
        /* Scrollbar tasarımı */
        /* Scrollbar tasarımı */
        .search-results::-webkit-scrollbar {
            width: 8px;
        }
        .search-results::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 8px;
        }
        .search-results::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 8px;
        }
        .search-results::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .fixed-search-container {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 300px;
            z-index: 999;
        }
        .search-container {
            position: fixed;
            top: 80px;
            right: 80px;
            width: 300px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .search-wrapper {
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .search-container .input-group {
            width: 100%;
            position: relative;
        }
        
        .search-container input {
            height: 38px;
            border: 1px solid #e3f2fd;
            border-radius: 8px 0 0 8px;
            font-size: 14px;
            padding-left: 15px;
            width: calc(100% - 50px); /* Arama butonu için alan bırak */
        }
        
        .search-container .btn {
            height: 38px;
            padding: 0 15px;
            font-size: 14px;
            background-color: #2196f3;
            border: none;
            border-radius: 0 8px 8px 0;
            position: absolute;
            right: 0;
        }
        
        .search-container .btn:hover {
            background-color: #1976d2;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1001;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        
        /* Sayfa kaydırıldığında bile sabit kalması için */
        html {
            scroll-behavior: smooth;
        }
        
        body {
            position: relative;
        }
        /* Mobil uyumluluk için medya sorgusu */
        @media (max-width: 768px) {
            .fixed-search-container {
                width: calc(100% - 40px);
                top: 70px;
            }
        }
        .search-result-item.active {
            background-color: #e9ecef;
            color: #000;
        }
        
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: #f8f9fa;
        }
        .country-title {
            font-size: 1.8rem;
            font-weight: 500;
            color: #6c757d;
            margin-top: 20px;
            margin-bottom: 20px;
            text-transform: capitalize;
            transition: all 0.3s ease;
        }
        /* Alert stili */
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050;
            min-width: 300px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .alert.fade {
            transition: opacity 0.15s linear;
        }

        .alert.fade.show {
            opacity: 1;
        }

        /* Tema değişikliği için stil */
        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }
        .dark-mode .navbar {
            background-color: #333;
        }
        .dark-mode .navbar-brand, .dark-mode .nav-link {
            color: #ffffff !important;
        }
        .dark-mode .map-container, .dark-mode .info-grid-container {
            background-color: #1e1e1e;
            color: #ffffff;
        }
        .dark-mode .info-box {
            background-color: #2c2c2c;
            border-color: #444;
        }
        .dark-mode .btn {
            background-color: #444;
            color: #ffffff;
        }
        .dark-mode .btn:hover {
            background-color: #555;
        }

        /* Tema değişikliği için stil güncellemeleri */
        .dark-mode .search-container .search-wrapper {
            background-color: #1e1e1e;
            box-shadow: 0 2px 10px rgba(255,255,255,0.1);
        }

        .dark-mode .search-container input {
            background-color: #2c2c2c;
            border-color: #444;
            color: #ffffff;
        }

        .dark-mode .search-container input::placeholder {
            color: #888;
        }

        .dark-mode .search-results {
            background-color: #1e1e1e;
            box-shadow: 0 4px 8px rgba(255,255,255,0.1);
        }

        .dark-mode .search-result-item {
            color: #ffffff;
            border-bottom: 1px solid #444;
        }

        .dark-mode .search-result-item:hover,
        .dark-mode .search-result-item.active {
            background-color: #2c2c2c;
        }

        .dark-mode .country-name-container {
            background-color: #1e1e1e;
            box-shadow: 0 2px 10px rgba(255,255,255,0.05);
        }

        .dark-mode .country-title {
            color: #ffffff;
        }

        /* Göstergeler için karanlık tema stilleri */
        .dark-mode .info-box {
            background-color: #2c2c2c;
            border-color: #444;
        }

        .dark-mode .info-title {
            color: #64b5f6;
        }

        .dark-mode .info-content {
            color: #ffffff;
        }

        /* Google Gauge için karanlık tema stilleri */
        .dark-mode .google-visualization-gauge text {
            fill: #ffffff !important;
        }

        .dark-mode .google-visualization-gauge path {
            stroke: #444 !important;
        }

        .dark-mode .google-visualization-gauge > div {
            background-color: transparent !important;
        }

        /* Alert için karanlık tema */
        .dark-mode .alert {
            background-color: #2c2c2c;
            color: #ffffff;
            border-color: #444;
        }

        /* Scrollbar için karanlık tema */
        .dark-mode .search-results::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .dark-mode .search-results::-webkit-scrollbar-thumb {
            background: #444;
        }

        .dark-mode .search-results::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Harita kontrolleri için karanlık tema */
        .dark-mode .leaflet-bar a {
            background-color: #2c2c2c !important;
            color: #ffffff !important;
            border-color: #444 !important;
        }

        .dark-mode .leaflet-bar a:hover {
            background-color: #444 !important;
        }

        .dark-mode .leaflet-control-attribution {
            background-color: rgba(30, 30, 30, 0.8) !important;
            color: #ffffff !important;
        }

        /* Info box için karanlık tema */
        .dark-mode .info {
            background: rgba(30, 30, 30, 0.95);
            color: #ffffff;
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }

        .dark-mode .info h4 {
            color: #64b5f6;
        }
    </style>
</head>
<body>
    <script>
    // Sayfa yüklendiğinde tema durumunu kontrol et
    document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }
    });

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        // Tema durumunu localStorage'da sakla
        if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
        } else {
            localStorage.setItem('theme', 'light');
        }
    }
    </script>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="{% url 'map' %}">Dünya Ülkeleri Hayat Endeksi</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'map' %}">Ana Sayfa</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <!-- Tema Değiştir Butonu -->
                    <button class="btn btn-outline-primary" onclick="toggleTheme()">Temayı Değiştir</button>
                    <a href="{% url 'login' %}" class="btn btn-auth me-2">Giriş Yap</a>
                    <a href="{% url 'register' %}" class="btn btn-auth register">Kayıt Ol</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Arama Kutusu -->
    <div class="search-container">
        <div class="search-wrapper">
            <div class="input-group">
                <input type="text" 
                       id="countrySearch" 
                       class="form-control" 
                       placeholder="Ülke ara..." 
                       autocomplete="off">
                <button class="btn btn-primary" id="searchButton">
                    <i class="fas fa-search fa-sm"></i>
                </button>
            </div>
            <div id="searchResults" class="search-results" style="display: none;"></div>
        </div>
    </div>

    <!-- Harita Container -->
    <div class="map-container">
        <div id="map"></div>
    </div>

    <!-- Ülke İsmi Container -->
    <div class="country-name-container">
        <h1 class="country-title text-center mb-4" id="countryTitle">Turkey</h1>
    </div>

    <!-- Tablo Container -->
    <div class="info-grid-container">
        <div class="row">
            <div class="col-md-3">
                <!-- İlk sütun -->
                <div class="info-box mb-3" data-field="City">
                    <div class="info-title">City</div>
                    <div class="info-content">{{ country_data.City }}</div>
                </div>
                
                <!-- Diğer kutular -->
                <div class="info-box mb-3" data-field="Rank_x">
                    <div class="info-title">Rank X</div>
                    <div class="info-content">{{ country_data.Rank_x }}</div>
                    <div class="gauge-container" id="gauge-rank-x"></div>
                </div>
                <div class="info-box mb-3" data-field="Sunshine hours(City)">
                    <div class="info-title">Sunshine Hours</div>
                    <div class="info-content">{{ country_data.sunshine_hours }}</div>
                    <div class="gauge-container" id="gauge-sunshine-hours"></div>
                </div>
                <div class="info-box mb-3" data-field="Life expectancy(years) (Country)">
                    <div class="info-title">Life Expectancy</div>
                    <div class="info-content">{{ country_data.life_expectancy }}</div>
                    <div class="gauge-container" id="gauge-life-expectancy"></div>
                </div>
                <div class="info-box mb-3" data-field="Pollution(Index score) (City)">
                    <div class="info-title">Pollution Index</div>
                    <div class="info-content">{{ country_data.pollution_index }}</div>
                    <div class="gauge-container" id="gauge-pollution-index"></div>
                </div>
                <div class="info-box" data-field="Happiness levels(Country)">
                    <div class="info-title">Happiness Levels</div>
                    <div class="info-content">{{ country_data.happiness_levels }}</div>
                    <div class="gauge-container" id="gauge-happiness-levels"></div>
                </div>
            </div>
            <div class="col-md-3">
                <!-- İkinci 6 kutu -->
                <div class="info-box mb-3" data-field="Outdoor activities(City)">
                    <div class="info-title">Outdoor Activities</div>
                    <div class="info-content">{{ country_data.outdoor_activities }}</div>
                    <div class="gauge-container" id="gauge-outdoor-activities"></div>
                </div>
                <div class="info-box mb-3" data-field="Number of take out places(City)">
                    <div class="info-title">Take Out Places</div>
                    <div class="info-content">{{ country_data.takeout_places }}</div>
                    <div class="gauge-container" id="gauge-take-out-places"></div>
                </div>
                <div class="info-box mb-3" data-field="Cost of Living Index">
                    <div class="info-title">Cost of Living Index</div>
                    <div class="info-content">{{ country_data.cost_living_index }}</div>
                    <div class="gauge-container" id="gauge-cost-of-living-index"></div>
                </div>
                <div class="info-box mb-3" data-field="Rent Index">
                    <div class="info-title">Rent Index</div>
                    <div class="info-content">{{ country_data.rent_index }}</div>
                    <div class="gauge-container" id="gauge-rent-index"></div>
                </div>
                <div class="info-box mb-3" data-field="Cost of Living Plus Rent Index">
                    <div class="info-title">Cost of Living Plus Rent Index</div>
                    <div class="info-content">{{ country_data.cost_living_rent_index }}</div>
                    <div class="gauge-container" id="gauge-cost-of-living-plus-rent-index"></div>
                </div>
                <div class="info-box" data-field="Groceries Index">
                    <div class="info-title">Groceries Index</div>
                    <div class="info-content">{{ country_data.groceries_index }}</div>
                    <div class="gauge-container" id="gauge-groceries-index"></div>
                </div>
            </div>
            <div class="col-md-3">
                <!-- Üçüncü 6 kutu -->
                <div class="info-box mb-3" data-field="Restaurant Price Index">
                    <div class="info-title">Restaurant Price Index</div>
                    <div class="info-content">{{ country_data.restaurant_price_index }}</div>
                    <div class="gauge-container" id="gauge-restaurant-price-index"></div>
                </div>
                <div class="info-box mb-3" data-field="Local Purchasing Power Index">
                    <div class="info-title">Local Purchasing Power Index</div>
                    <div class="info-content">{{ country_data.local_purchasing_power }}</div>
                    <div class="gauge-container" id="gauge-local-purchasing-power-index"></div>
                </div>
                <div class="info-box mb-3" data-field="Rank_y">
                    <div class="info-title">Rank Y</div>
                    <div class="info-content"></div>
                    <div class="gauge-container" id="gauge-rank-y"></div>
                </div>
                <div class="info-box mb-3" data-field="Obesity levels(Country)">
                    <div class="info-title">Obesity Levels</div>
                    <div class="info-content">{{ country_data.obesity_levels }}</div>
                    <div class="gauge-container" id="gauge-obesity-levels"></div>
                </div>
                <div class="info-box" data-field="Annual avg. hours worked">
                    <div class="info-title">Annual Hours Worked</div>
                    <div class="info-content">{{ country_data.annual_hours_worked }}</div>
                    <div class="gauge-container" id="gauge-annual-hours-worked"></div>
                </div>
            </div>
            <div class="col-md-3">
                <!-- Son 2 kutu -->
                <div class="info-box mb-3" data-field="gym_membership_cost">
                    <div class="info-title">Gym Membership Cost</div>
                    <div class="info-content"></div>
                    <div class="gauge-container" id="gauge-gym-membership-cost"></div>
                </div>
                <div class="info-box mb-3" data-field="water_bottle_cost">
                    <div class="info-title">Water Bottle Cost</div>
                    <div class="info-content"></div>
                    <div class="gauge-container" id="gauge-water-bottle-cost"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert için div - başlığın altına ekleyin -->
    <div id="alertMessage" class="alert alert-warning alert-dismissible fade" role="alert" style="display: none;">
        <span id="alertText"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Mevcut harita script'i -->
    <script>
        // Haritayı başlat
        var map = L.map('map', {
            maxBounds: [[-60, -180], [85, 180]], // Antarktika'yı sınırla
            minZoom: 2,
            maxZoom: 8
        }).setView([30, 0], 2);
        
        // OpenStreetMap altlığını ekle
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            noWrap: true, // Haritanın tekrarını engelle
            bounds: [[-60, -180], [85, 180]] // Görünüm sınırları
        }).addTo(map);

        // GeoJSON verilerini yükle
        fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
            .then(response => response.json())
            .then(data => {
                // Antarktika'yı filtrele
                data.features = data.features.filter(feature => 
                    feature.properties.ADMIN !== 'Antarctica');
                
                // Ülke katmanını oluştur
                L.geoJSON(data, {
                    style: function(feature) {
                        return {
                            fillColor: '#3388ff',
                            weight: 1,
                            opacity: 1,
                            color: 'white',
                            fillOpacity: 0.3
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        // Hover efekti
                        layer.on({
                            mouseover: function(e) {
                                var layer = e.target;
                                layer.setStyle({
                                    fillColor: '#666',
                                    fillOpacity: 0.7
                                });
                                layer.bindPopup(feature.properties.ADMIN).openPopup();
                            },
                            mouseout: function(e) {
                                var layer = e.target;
                                layer.setStyle({
                                    fillColor: '#3388ff',
                                    fillOpacity: 0.3
                                });
                            },
                            click: function(e) {
                                const countryName = feature.properties.ADMIN;
                                getCountryData(countryName); // Yeni eklenen fonksiyon çağrısı
                            }
                        });
                    }
                }).addTo(map);
            })
            .catch(error => console.error('Hata:', error));

        // Bilgi kutusu ekle
        var info = L.control({ position: 'topleft' });
        info.onAdd = function(map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };

        info.update = function(props) {
            this._div.innerHTML = '<h4>Ülke Bilgisi</h4>' + 
                (props ? '<b>' + props.ADMIN + '</b>' : 'Fare ile ülkenin üzerine gelin');
        };

        info.addTo(map);

        // Veritabanı bağlantısı için yeni eklenen kodlar
        function showAlert(message) {
            const alertDiv = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');
            alertText.textContent = message;
            alertDiv.classList.add('show');
            alertDiv.style.display = 'block';
            
            // 5 saniye sonra alert'i otomatik kapat
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 150);
            }, 5000);
        }

        function getCountryData(countryName) {
            console.log('Fetching data for:', countryName);
            
            fetch(`/api/country-data/${encodeURIComponent(countryName)}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Country not found');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Ülke adını güncelle
                    document.getElementById('countryTitle').textContent = countryName;

                    // Veri eşleştirme tablosu
                    const fieldMappings = {
                        'City': 'City',
                        'Rank_x': 'Rank_x',
                        'Sunshine hours(City)': 'sunshine_hours',
                        'Life expectancy(years) (Country)': 'life_expectancy',
                        'Pollution(Index score) (City)': 'pollution_index',
                        'Happiness levels(Country)': 'happiness_levels',
                        'Outdoor activities(City)': 'outdoor_activities',
                        'Number of take out places(City)': 'takeout_places',
                        'Cost of Living Index': 'cost_living_index',
                        'Rent Index': 'rent_index',
                        'Cost of Living Plus Rent Index': 'cost_living_rent_index',
                        'Groceries Index': 'groceries_index',
                        'Restaurant Price Index': 'restaurant_price_index',
                        'Local Purchasing Power Index': 'local_purchasing_power',
                        'Rank_y': 'Rank_y',
                        'Obesity levels(Country)': 'obesity_levels',
                        'Annual avg. hours worked': 'annual_hours_worked',
                        'Cost of a monthly gym membership(City)': 'gym_membership_cost',
                        'Cost of a bottle of water(City)': 'water_bottle_cost'
                    };

                    // Her bir info-box'ı güncelle
                    document.querySelectorAll('.info-box').forEach(box => {
                        const fieldName = box.getAttribute('data-field');
                        const contentDiv = box.querySelector('.info-content');
                        
                        if (fieldName && contentDiv) {
                            const value = data[fieldMappings[fieldName] || fieldName];
                            
                            if (value !== null && value !== undefined) {
                                if (typeof value === 'number') {
                                    contentDiv.textContent = value.toLocaleString('en-US', {
                                        maximumFractionDigits: 2,
                                        minimumFractionDigits: 0
                                    });
                                } else {
                                    contentDiv.textContent = value;
                                }

                                // Gauge'i güncelle
                                const gaugeDiv = box.querySelector('.gauge-container');
                                if (gaugeDiv && typeof value === 'number') {
                                    const gaugeId = gaugeDiv.id;
                                    drawGauge(gaugeId, fieldName, value);
                                }
                            } else {
                                contentDiv.textContent = '-';
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        title: 'Hata',
                        text: 'Bu ülke için veri bulunamadı veya bir hata oluştu.',
                        icon: 'error',
                        confirmButtonText: 'Tamam'
                    });
                });
        }

        // Turkey verilerini getiren yeni fonksiyon
        function getDefaultTurkeyData() {
            fetch('/api/country-data/Turkey/')
                .then(response => response.json())
                .then(data => {
                    // Info-box'ları Turkey verileriyle güncelle
                    document.querySelectorAll('.info-box').forEach(box => {
                        const fieldName = box.getAttribute('data-field');
                        const contentDiv = box.querySelector('.info-content');
                        
                        if (fieldName && contentDiv) {
                            let value = data[fieldName];
                            
                            if (value !== null && value !== undefined) {
                                if (typeof value === 'number') {
                                    contentDiv.textContent = value.toLocaleString('en-US', {
                                        maximumFractionDigits: 2,
                                        minimumFractionDigits: 0
                                    });
                                } else {
                                    contentDiv.textContent = value;
                                }
                            } else {
                                contentDiv.textContent = '-';
                            }

                            const gaugeDiv = box.querySelector('.gauge-container');
                            if (gaugeDiv && typeof value === 'number') {
                                const gaugeId = gaugeDiv.id;
                                drawGauge(gaugeId, fieldName, value);
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching Turkey data:', error);
                });
        }

        // Seçili ülkeyi vurgula
        function highlightSelectedCountry(countryName) {
            // Önce tüm ülkelerin vurgusunu kaldır
            document.querySelectorAll('#map-container path').forEach(path => {
                path.style.fill = ''; // Varsayılan renk
            });

            // Seçili ülkeyi vurgula
            const selectedCountry = document.querySelector(`#map-container path[title="${countryName}"]`);
            if (selectedCountry) {
                selectedCountry.style.fill = '#4a90e2'; // Vurgulama rengi
            }
        }

        // Haritaya hover efekti ekle
        document.querySelectorAll('#map-container path').forEach(path => {
            path.addEventListener('mouseenter', function() {
                if (this.style.fill !== '#4a90e2') { // Seçili değilse
                    this.style.fill = '#69b3e7'; // Hover rengi
                }
            });

            path.addEventListener('mouseleave', function() {
                if (this.style.fill !== '#4a90e2') { // Seçili değilse
                    this.style.fill = ''; // Varsayılan renk
                }
            });
        });

        // Sayfa yüklendiğinde varsayılan olarak Türkiye verilerini göster
        getCountryData('Turkey');
    </script>

    <script>
    google.charts.load('current', {'packages':['gauge']});
    google.charts.setOnLoadCallback(drawGauges);

    function drawGauges() {
        document.querySelectorAll('.info-box').forEach(box => {
            const title = box.querySelector('.info-title').textContent;
            const value = parseFloat(box.querySelector('.info-content').textContent);
            const gaugeContainer = box.querySelector('.gauge-container');
            
            if (gaugeContainer) {
                const gaugeId = gaugeContainer.id;
                if (gaugeId) {
                    drawGauge(gaugeId, title, value);
                }
            }
        });
    }

    function drawGauge(containerId, title, value) {
        // Değeri sayısal formata dönüştür
        value = parseFloat(value);
        
        // Eğer değer geçerli bir sayı değilse, varsayılan değer kullan
        if (isNaN(value)) {
            console.log(`Invalid gauge value for ${title}:`, value);
            value = 50;
        }

        const data = google.visualization.arrayToDataTable([
            ['Label', 'Value'],
            ['', calculatePercentile(value, title)]
        ]);

        const options = {
            width: 40,
            height: 40,
            redFrom: 0,
            redTo: 35,
            yellowFrom: 35,
            yellowTo: 65,
            greenFrom: 65,
            greenTo: 100,
            min: 0,
            max: 100,
            startAngle: 180,
            endAngle: 0,
            majorTicks: [],
            minorTicks: 2,
            backgroundColor: { fill: 'transparent' },
            animation: {
                duration: 400,
                easing: 'out'
            }
        };

        const chart = new google.visualization.Gauge(document.getElementById(containerId));
        chart.draw(data, options);
    }

    function calculatePercentile(value, metric) {
        // Önce değeri sayısal formata dönüştürelim
        value = parseFloat(value);
        
        // Eğer değer geçerli bir sayı değilse
        if (isNaN(value)) {
            console.log(`Invalid value for ${metric}:`, value);
            return 50; // varsayılan değer
        }

        const metrics = {
            'Rank_x': { avg: 100, std: 50 },
            'Sunshine hours(City)': { avg: 2081.21, std: 800 },
            'Life expectancy(years) (Country)': { avg: 77.22, std: 5 },
            'Pollution(Index score) (City)': { avg: 60.43, std: 20 },
            'Happiness levels(Country)': { avg:6.27, std: 1 },
            'Outdoor activities(City)': { avg: 235.71, std: 75 },
            'Number of take out places(City)': { avg: 1626, std: 150 },
            'Cost of Living Index': { avg: 50.6, std: 25 },
            'Rent Index': { avg: 19.77, std: 15 },
            'Cost of Living Plus Rent Index': { avg: 50, std: 20 },
            'Groceries Index': { avg: 53.68, std: 20 },
            'Restaurant Price Index': { avg: 45.15, std: 25 },
            'Local Purchasing Power Index': { avg: 91.92, std: 30 },
            'Rank_y': { avg: 100, std: 50 },
            'Obesity levels(Country)': { avg: 25, std: 10 },
            'Annual avg. hours worked': { avg: 1800, std: 200 },
            'Cost of a monthly gym membership(City)': { avg: 3438, std: 20 },
            'Cost of a bottle of water(City)': { avg: 0.96, std: 0.5 }
        };

        const metricData = metrics[metric];
        if (!metricData) {
            console.log(`No metric data for ${metric}`);
            return 50;
        }

        const zScore = (value - metricData.avg) / metricData.std;
        let percentile = (zScore + 3) * (100 / 6);
        return Math.min(Math.max(percentile, 0), 100);
    }

    function updateInfoBoxes(data) {
        document.querySelector('[data-field="city"] .info-content').textContent = data.city;
        document.querySelector('[data-field="rank_x"] .info-content').textContent = data.rank_x;
        // Diğer alanlar için benzer şekilde devam eder
    }

    function updateCountryName(countryName) {
        document.querySelector('.country-name').textContent = countryName;
    }

    window.addEventListener('load', drawGauges);
    window.addEventListener('resize', drawGauges);
    </script>

    <!-- JavaScript kodu -->
    <script>
    let currentFocus = -1;  // Seçili sonuç indeksi

    document.getElementById('countrySearch').addEventListener('input', function(e) {
        const searchTerm = e.target.value;
        const resultsContainer = document.getElementById('searchResults');
        currentFocus = -1;  // Yeni arama yapıldığında seçimi sıfırla
        
        if (searchTerm.length >= 1) {
            fetch(`/search-countries/?term=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(countries => {
                    if (countries.length > 0) {
                        resultsContainer.innerHTML = countries
                            .map(country => `
                                <div class="search-result-item" data-country="${country}">
                                    ${country}
                                </div>
                            `).join('');
                        resultsContainer.style.display = 'block';
                    } else {
                        resultsContainer.innerHTML = '<div class="search-result-item">Sonuç bulunamadı</div>';
                        resultsContainer.style.display = 'block';
                    }
                })
                .catch(error => console.error('Arama hatası:', error));
        } else {
            resultsContainer.style.display = 'none';
        }
    });

    // Klavye tuşları ile gezinme
    document.getElementById('countrySearch').addEventListener('keydown', function(e) {
        const resultsContainer = document.getElementById('searchResults');
        const items = resultsContainer.getElementsByClassName('search-result-item');
        
        if (!items.length) return;

        // Aşağı tuşu
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentFocus++;
            if (currentFocus >= items.length) currentFocus = 0;
            setActiveItem(items);
        }
        // Yukarı tuşu
        else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentFocus--;
            if (currentFocus < 0) currentFocus = items.length - 1;
            setActiveItem(items);
        }
        // Enter tuşu
        else if (e.key === 'Enter' && currentFocus > -1) {
            e.preventDefault();
            if (items[currentFocus]) {
                const country = items[currentFocus].dataset.country;
                this.value = country;
                resultsContainer.style.display = 'none';
                getCountryData(country);
            }
        }
        // Escape tuşu
        else if (e.key === 'Escape') {
            resultsContainer.style.display = 'none';
            currentFocus = -1;
        }
    });

    // Aktif elemanı işaretle
    function setActiveItem(items) {
        // Önce tüm active sınıflarını kaldır
        Array.from(items).forEach(item => {
            item.classList.remove('active');
        });
        
        // Yeni seçili elemana active sınıfı ekle
        if (currentFocus >= 0 && items[currentFocus]) {
            items[currentFocus].classList.add('active');
            // Seçili elemanı görünür alana kaydır
            items[currentFocus].scrollIntoView({ block: 'nearest' });
        }
    }

    // Stil eklemeleri
    const additionalStyles = `
        .search-result-item.active {
            background-color: #e9ecef;
            color: #000;
        }
        
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: #f8f9fa;
        }
    `;

    // Yeni stilleri ekle
    const styleSheet = document.createElement("style");
    styleSheet.innerText = additionalStyles;
    document.head.appendChild(styleSheet);

    // Arama sonuçlarına tıklama
    document.getElementById('searchResults').addEventListener('click', function(e) {
        const item = e.target.closest('.search-result-item');
        if (item) {
            const country = item.dataset.country;
            getCountryData(country);
            // Arama kutusunu temizle
            document.getElementById('countrySearch').value = '';
            this.style.display = 'none';
        }
    });

    // Sayfa herhangi bir yerine tıklandığında sonuçları gizle
    document.addEventListener('click', function(e) {
        const searchContainer = document.querySelector('.search-container');
        const resultsContainer = document.getElementById('searchResults');
        if (!searchContainer.contains(e.target)) {
            resultsContainer.style.display = 'none';
        }
    });

    // Enter tuşu ile arama
    document.getElementById('countrySearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const searchTerm = this.value;
            if (searchTerm) {
                document.getElementById('searchResults').style.display = 'none';
                getCountryData(searchTerm);
            }
        }
    });

    // Arama butonu ile arama
    document.getElementById('searchButton').addEventListener('click', function() {
        const searchTerm = document.getElementById('countrySearch').value;
        if (searchTerm) {
            document.getElementById('searchResults').style.display = 'none';
            getCountryData(searchTerm);
        }
    });

    // Enter tuşu ile seçim için event listener'ı güncelle
    document.getElementById('countrySearch').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && currentFocus > -1) {
            const items = document.getElementsByClassName('search-result-item');
            if (items[currentFocus]) {
                e.preventDefault();
                const country = items[currentFocus].dataset.country;
                getCountryData(country);
                // Arama kutusunu temizle
                this.value = '';
                document.getElementById('searchResults').style.display = 'none';
            }
        }
    });

    // Arama kutusu blur (focus kaybı) olayını dinle
    document.getElementById('countrySearch').addEventListener('blur', function() {
        // Kısa bir gecikme ile temizle (kullanıcının seçim yapmasına izin ver)
        setTimeout(() => {
            this.value = '';
            document.getElementById('searchResults').style.display = 'none';
        }, 200);
    });
    </script>

    <datalist id="countryList"></datalist>

    <!-- Harita tıklama olayını dinle -->
    <script>
    document.querySelector('#map-container').addEventListener('click', function(e) {
        const path = e.target.closest('path');
        if (path) {
            const countryName = path.getAttribute('title');
            if (countryName) {
                // Önce ülkenin veritabanında olup olmadığını kontrol et
                checkCountryExists(countryName);
            }
        }
    });

    // Ülkenin veritabanında olup olmadığını kontrol et
    function checkCountryExists(countryName) {
        fetch(`/api/country-data/${encodeURIComponent(countryName)}/`)
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('NOT_FOUND');
                    }
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                // Ülke bulunduysa verileri getir
                document.getElementById('countrySearch').value = countryName;
                getCountryData(countryName);
            })
            .catch(error => {
                console.error('Error:', error);
                if (error.message === 'NOT_FOUND') {
                    showAlert(`${countryName} ülkesine ait veri bulunmamaktadır.`);
                    // Mevcut verileri korumak için hiçbir şey yapma
                } else {
                    showAlert('Veri getirme sırasında bir hata oluştu.');
                }
            });
    }
    </script>

    <script src="{% static 'js/map.js' %}"></script>
</body>
</html> 